---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/default.astro';
import PostCard from "../../components/post-card.astro"

export async function getStaticPaths() {
  const posts = (await getCollection('posts'))
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  const uniqueTags = [...new Set(posts.map((post: any) => post.data.tags).flat())];

  return uniqueTags.filter(Boolean).map(tag => {
    console.log(tag);
    return {
      params: { tag },
      props: { posts: posts.filter(({ data: { tags }}) => tags.includes(tag)) },
    }
  });
};

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<Layout title={`Posts tagged with ${tag}`}>
<h1>Posts tagged with {tag}</h1>
<ul>
{posts.map((post: any) => <li>
<PostCard {...post.data} href={`/posts/${post.id}`} />
</li>)}
</ul>
</Layout>
